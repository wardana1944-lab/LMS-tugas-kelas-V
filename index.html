<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruang Belajar - SD NEGERI PENGKOL</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      --primary: #0ea5e9; --bg: #030712; --glass: rgba(255, 255, 255, 0.03); 
      --border: rgba(255, 255, 255, 0.08);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
    body { background: var(--bg); color: #f8fafc; min-height: 100vh; padding: 20px 15px; }
    .container { max-width: 800px; margin: 0 auto; }

    /* HEADER SESUAI PERMINTAAN */
    .brand-header { text-align: center; margin-bottom: 30px; }
    .brand-header h1 { font-size: 2.2rem; font-weight: 800; background: linear-gradient(to bottom, #ffffff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
    .brand-header p { font-size: 0.8rem; letter-spacing: 3px; color: var(--primary); font-weight: 700; }

    .info-bar { background: var(--glass); border: 1px solid var(--border); padding: 12px 20px; border-radius: 100px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    
    /* PROFIL GURU DENGAN NIP */
    .guru-profile { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .guru-profile img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); }
    .guru-info { text-align: right; }
    .guru-info .nama { font-size: 0.75rem; font-weight: 700; color: #fff; }
    .guru-info .nip { font-size: 0.55rem; color: #94a3b8; font-family: monospace; }

    .banner { text-align:center; padding:12px; border-radius:12px; margin-bottom:25px; border: 1px solid rgba(14,165,233,0.3); background: rgba(14,165,233,0.05); color: var(--primary); font-weight: 700; font-size: 0.8rem; }

    /* GRID SISWA 3 KOLOM */
    .grid-siswa { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 12px; 
    }
    .card-siswa { 
      background: var(--glass); border: 1px solid var(--border); 
      padding: 15px 5px; border-radius: 20px; text-align: center; 
      cursor: pointer; transition: 0.3s; min-height: 140px;
      display: flex; flex-direction: column; justify-content: center;
    }
    .card-siswa:hover { border-color: var(--primary); background: rgba(14,165,233,0.1); }
    .card-siswa span { font-size: 2.2rem; display: block; margin-bottom: 8px; }
    .card-siswa p { font-size: 0.65rem; font-weight: 700; line-height: 1.2; color: #cbd5e1; }

    /* OVERLAY SYSTEM */
    .panel-overlay { 
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: #030712; z-index: 9999; overflow-y: auto; padding: 25px 15px;
    }

    /* BENTO MENU GURU */
    .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .bento-card { 
      background: #111827; border: 1px solid var(--border); padding: 20px; 
      border-radius: 24px; cursor: pointer; text-align: center;
    }
    .bento-card .icon { font-size: 1.8rem; display: block; margin-bottom: 10px; }
    .bento-card h4 { font-size: 0.85rem; color: #fff; }

    /* CBT UI */
    .nomor-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; justify-content: center; }
    .btn-nomor { width: 35px; height: 35px; border-radius: 8px; border: 1px solid #374151; background: #1f2937; color: white; font-weight: 700; cursor: pointer; }
    .btn-nomor.active { background: var(--primary); border-color: var(--primary); }
    .btn-nomor.filled { background: #10b981; border-color: #10b981; }

    .soal-box { background: white; color: #1e293b; padding: 25px; border-radius: 20px; margin-bottom: 20px; }
    .opsi-btn { 
      padding: 14px; border: 2px solid #f1f5f9; border-radius: 12px; margin-bottom: 10px; 
      cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; font-size: 0.9rem;
    }
    .opsi-btn.selected { border-color: var(--primary); background: #f0f9ff; color: var(--primary); }

    .btn-action { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; }
    input, textarea, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; margin: 8px 0; }
  </style>
</head>
<body>

<div class="container">
  <div class="brand-header">
    <h1>RUANG BELAJAR</h1>
    <p>SD NEGERI PENGKOL</p>
  </div>

  <div class="info-bar">
    <div style="font-size: 0.65rem; color: #94a3b8; font-weight: 600;">KELAS V ‚Ä¢ 2025/2026</div>
    <div class="guru-profile" onclick="openLogin()">
      <div class="guru-info">
        <p class="nama">Aditya W. W., S.Pd</p>
        <p class="nip">NIP. 19940319 202321 1 005</p>
      </div>
      <img src="https://ui-avatars.com/api/?name=Aditya+WW&background=0ea5e9&color=fff">
    </div>
  </div>

  <div id="statusTugas" class="banner">Memeriksa tugas...</div>
  <div class="grid-siswa" id="gridSiswa"></div>
</div>

<div id="panelKerja" class="panel-overlay" style="background: #f8fafc; color: #1e293b;">
  <div class="container" style="max-width: 600px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h4 id="namaSiswaHi" style="font-size: 0.9rem; color: #64748b;"></h4>
      <button onclick="closeAllPanels()" style="border:none; background:none; color:red; font-weight:800; cursor:pointer;">KELUAR</button>
    </div>
    <div class="nomor-grid" id="nomorGrid"></div>
    <div class="soal-box">
      <div id="soalKe" style="color: var(--primary); font-weight: 800; font-size: 0.7rem; margin-bottom: 8px;"></div>
      <p id="isiSoalTeks" style="font-size: 1.05rem; font-weight: 700; margin-bottom: 20px; line-height: 1.4;"></p>
      <div id="isiOpsi"></div>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn-action" style="background:#e2e8f0; color:#475569" onclick="geserSoal(-1)">KEMBALI</button>
      <button class="btn-action" style="background:var(--primary); color:white" onclick="geserSoal(1)">LANJUT</button>
    </div>
    <button id="btnFinish" class="btn-action" style="background:#10b981; color:white; display:none; margin-top:20px;" onclick="prosesSelesai()">KIRIM JAWABAN</button>
  </div>
</div>

<div id="panelGuru" class="panel-overlay">
  <div class="container" style="max-width: 500px;">
    <h2 style="text-align:center; margin-bottom: 25px; letter-spacing: 1px;">MENU KONTROL GURU</h2>
    <div class="bento-grid">
      <div class="bento-card" onclick="openView('panelBuat')">
        <span class="icon">üìù</span>
        <h4>Buat Tugas</h4>
      </div>
      <div class="bento-card" onclick="openView('panelRekap')">
        <span class="icon">üìä</span>
        <h4>Rekap Nilai</h4>
      </div>
      <div class="bento-card" style="border-color: #ef4444;" onclick="resetTugas()">
        <span class="icon">üóëÔ∏è</span>
        <h4 style="color: #ef4444;">Hapus Tugas</h4>
      </div>
      <div class="bento-card" onclick="location.reload()">
        <span class="icon">üö™</span>
        <h4>Keluar</h4>
      </div>
    </div>
  </div>
</div>

<div id="panelBuat" class="panel-overlay" style="background: #f1f5f9; color: #1e293b;">
  <div class="container" style="max-width: 500px;">
    <h3 style="margin-bottom:20px;">üìù Setting Tugas</h3>
    <input type="text" id="judulMateri" placeholder="Judul Materi/Mata Pelajaran">
    <select id="jenisTugas" onchange="resetFormSoal()">
      <option value="pg">Pilihan Ganda (A - D)</option>
      <option value="uraian">Uraian / Essay</option>
    </select>
    <div id="wadahSoal"></div>
    <button class="btn-action" style="background:#94a3b8; color:white" onclick="tambahSoalItem()">+ Tambah Soal</button>
    <button class="btn-action" style="background:var(--primary); color:white" onclick="terbitkanTugas()">TERBITKAN</button>
    <button class="btn-action" style="background:#ef4444; color:white" onclick="closeView('panelBuat')">BATAL</button>
  </div>
</div>

<div id="modalLogin" class="panel-overlay" style="background: rgba(0,0,0,0.95); display:none; align-items:center; justify-content:center;">
  <div style="background:#1f2937; padding:30px; border-radius:24px; width:320px; text-align:center; border:1px solid var(--border);">
    <h4 style="margin-bottom:20px; color:white;">Akses Guru</h4>
    <input type="password" id="pinInput" placeholder="Masukkan PIN" style="text-align:center; font-size:1.2rem; background: rgba(0,0,0,0.2); color:white; border:none;">
    <button class="btn-action" style="background:var(--primary); color:white" onclick="cekLogin()">LOG IN</button>
    <button style="background:none; border:none; color:#94a3b8; margin-top:15px; cursor:pointer;" onclick="closeAllPanels()">Tutup</button>
  </div>
</div>

<canvas id="canvasHasil" style="display:none;"></canvas>

<script>
const API = "https://script.google.com/macros/s/AKfycbzKSeF0P2w2x1sszm09pLl1lEzApYHH9xbG1UISa5SoiDWfrle5L4iF7jbh8LtdqgyHvA/exec";
const SISWA = [{n:"Alvaro Adnan Aji Pambudi",i:"üë¶"},{n:"Anantha Yudha Diztira",i:"üë¶"},{n:"Arifah Yhuan Nur Azizah",i:"üëß"},{n:"Aurelia Gieni Lindria Putri",i:"üëß"},{n:"Dhafitha Nizza Nur Azizah",i:"üëß"},{n:"Dhian Rahmawati",i:"üëß"},{n:"Dimas Rasyid Faristia",i:"üë¶"},{n:"Erfin Denu Setiawan",i:"üë¶"},{n:"Marsya Anindya Kiera",i:"üëß"},{n:"Mikayla Ayuningtyas",i:"üëß"},{n:"Muhammad Ozil Ramadhan",i:"üë¶"},{n:"Rhevan Nabil Yudanta",i:"üë¶"},{n:"Ridho Wicaksono",i:"üë¶"},{n:"Rizky Syam Dani",i:"üë¶"},{n:"Tanca Al Verosa",i:"üë¶"}];

let dataWeb = null, userSekarang = "", indeksSoal = 0, jawabanSiswa = [];

window.onload = init;

async function init() {
  const grid = document.getElementById('gridSiswa');
  grid.innerHTML = "";
  SISWA.forEach(s => { grid.innerHTML += `<div class="card-siswa" onclick="mulaiTugas('${s.n}')"><span>${s.i}</span><p>${s.n}</p></div>`; });
  try {
    const res = await fetch(API + "?action=getAllData");
    dataWeb = await res.json();
    document.getElementById('statusTugas').innerText = dataWeb.tugas.judul === "TIDAK ADA TUGAS" ? "BELUM ADA TUGAS" : "TUGAS: " + dataWeb.tugas.judul;
  } catch(e) { document.getElementById('statusTugas').innerText = "Koneksi Bermasalah"; }
}

function mulaiTugas(nama) {
  if(!dataWeb || dataWeb.tugas.judul === "TIDAK ADA TUGAS") return alert("Belum ada tugas.");
  userSekarang = nama; indeksSoal = 0;
  jawabanSiswa = new Array(dataWeb.tugas.soal.length).fill("");
  document.getElementById('namaSiswaHi').innerText = "Siswa: " + nama;
  document.getElementById('panelKerja').style.display = 'block';
  renderSoalCBT();
}

function renderSoalCBT() {
  const s = dataWeb.tugas.soal[indeksSoal];
  document.getElementById('soalKe').innerText = `SOAL NO. ${indeksSoal + 1}`;
  document.getElementById('isiSoalTeks').innerText = s.tanya;
  const container = document.getElementById('isiOpsi');
  container.innerHTML = "";
  if(dataWeb.tugas.jenis === 'pg') {
    ['A','B','C','D'].forEach((l, i) => {
      const active = jawabanSiswa[indeksSoal] === l ? 'selected' : '';
      container.innerHTML += `<div class="opsi-btn ${active}" onclick="saveAns('${l}')"><b>${l}.</b> ${s.opsi[i]}</div>`;
    });
  } else {
    container.innerHTML = `<textarea oninput="saveAns(this.value)" placeholder="Ketik jawaban..." style="height:120px">${jawabanSiswa[indeksSoal]}</textarea>`;
  }
  const gn = document.getElementById('nomorGrid'); gn.innerHTML = "";
  dataWeb.tugas.soal.forEach((_, i) => {
    const cls = (i === indeksSoal) ? 'active' : (jawabanSiswa[i] !== "" ? 'filled' : '');
    gn.innerHTML += `<button class="btn-nomor ${cls}" onclick="indeksSoal=${i};renderSoalCBT()">${i+1}</button>`;
  });
  document.getElementById('btnFinish').style.display = (indeksSoal === dataWeb.tugas.soal.length - 1) ? 'block' : 'none';
}

function saveAns(v) { jawabanSiswa[indeksSoal] = v; renderSoalCBT(); }
function geserSoal(a) { let n = indeksSoal + a; if(n >= 0 && n < dataWeb.tugas.soal.length) { indeksSoal = n; renderSoalCBT(); } }

function openLogin() { document.getElementById('modalLogin').style.display = 'flex'; }
function cekLogin() { if(document.getElementById('pinInput').value === "1234") { closeAllPanels(); openView('panelGuru'); } else alert("PIN Salah!"); }
function openView(id) { document.getElementById(id).style.display = 'block'; }
function closeView(id) { document.getElementById(id).style.display = 'none'; }
function closeAllPanels() { document.querySelectorAll('.panel-overlay').forEach(p => p.style.display = 'none'); }

function tambahSoalItem() {
  const id = Date.now();
  const tipe = document.getElementById('jenisTugas').value;
  const html = `
    <div style="background:white; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #ddd;" id="item-${id}">
      <b>Pertanyaan:</b><textarea class="q-tanya"></textarea>
      ${tipe === 'pg' ? `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
          <input class="oa" placeholder="Opsi A"><input class="ob" placeholder="Opsi B">
          <input class="oc" placeholder="Opsi C"><input class="od" placeholder="Opsi D">
        </div>
        <b>Kunci:</b><select class="q-kunci"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
      ` : ''}
      <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; font-size:0.7rem; font-weight:800; cursor:pointer; margin-top:5px;">HAPUS SOAL</button>
    </div>`;
  document.getElementById('wadahSoal').insertAdjacentHTML('beforeend', html);
}

function resetFormSoal() { document.getElementById('wadahSoal').innerHTML = ""; tambahSoalItem(); }

async function terbitkanTugas() {
  const payload = { action: "setTugas", judul: document.getElementById('judulMateri').value, jenis: document.getElementById('jenisTugas').value, soal: [] };
  document.querySelectorAll('#wadahSoal > div').forEach(el => {
    let s = { tanya: el.querySelector('.q-tanya').value };
    if(payload.jenis === 'pg') {
      s.opsi = [el.querySelector('.oa').value, el.querySelector('.ob').value, el.querySelector('.oc').value, el.querySelector('.od').value];
      s.kunci = el.querySelector('.q-kunci').value;
    }
    payload.soal.push(s);
  });
  await fetch(API, { method: "POST", body: JSON.stringify(payload) });
  alert("Tugas Berhasil Terbit!"); location.reload();
}

async function prosesSelesai() {
  if(!confirm("Kirim sekarang?")) return;
  const btn = document.getElementById('btnFinish'); btn.innerText = "MENGIRIM..."; btn.disabled = true;
  let bnr = 0;
  dataWeb.tugas.soal.forEach((s, i) => { if(dataWeb.tugas.jenis === 'pg' && jawabanSiswa[i] === s.kunci) bnr++; });
  const nilai = dataWeb.tugas.jenis === 'pg' ? Math.round((bnr / dataWeb.tugas.soal.length) * 100) : "Selesai";
  
  const cvs = document.getElementById('canvasHasil'); const ctx = cvs.getContext('2d');
  cvs.width = 500; cvs.height = 700; ctx.fillStyle = "white"; ctx.fillRect(0,0,500,700);
  ctx.fillStyle = "#0ea5e9"; ctx.fillRect(0,0,500,60); ctx.fillStyle = "white"; ctx.font="bold 20px Arial"; ctx.fillText("HASIL KERJA", 20, 40);
  ctx.fillStyle = "#1e293b"; ctx.font="bold 14px Arial"; ctx.fillText(`Nama: ${userSekarang}`, 20, 100); ctx.fillText(`Nilai: ${nilai}`, 20, 130);
  let y=180; jawabanSiswa.forEach((j, i) => { ctx.fillText(`${i+1}. ${j}`, 30, y); y+=25; });
  const imgData = cvs.toDataURL("image/jpeg", 0.6).split(',')[1];

  await fetch(API, { method: "POST", body: JSON.stringify({ action: "upload", nama: userSekarang, materi: dataWeb.tugas.judul, nilai: nilai, file: imgData, filename: userSekarang + ".jpg" })});
  alert("Terkirim!"); location.reload();
}

async function resetTugas() {
  if(confirm("Hapus tugas ini?")) {
    await fetch(API, { method: "POST", body: JSON.stringify({ action: "setTugas", judul: "TIDAK ADA TUGAS", jenis: "pg", soal: [] }) });
    location.reload();
  }
}
</script>
</body>
</html>
