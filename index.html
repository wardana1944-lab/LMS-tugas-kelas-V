<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruang Belajar - SD N Pengkol</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      --primary: #0ea5e9; --bg: #030712; --glass: rgba(255, 255, 255, 0.03); 
      --border: rgba(255, 255, 255, 0.08);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
    body { background: var(--bg); color: #f8fafc; min-height: 100vh; padding: 20px 15px; }
    .container { max-width: 800px; margin: 0 auto; }

    /* HEADER UTAMA */
    .brand-header { text-align: center; margin-bottom: 30px; }
    .brand-header h1 { font-size: 2.2rem; font-weight: 800; background: linear-gradient(to bottom, #ffffff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .info-bar { background: var(--glass); border: 1px solid var(--border); padding: 12px 20px; border-radius: 100px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .guru-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .guru-profile img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--primary); }

    .banner { text-align:center; padding:12px; border-radius:12px; margin-bottom:25px; border: 1px solid rgba(14,165,233,0.3); background: rgba(14,165,233,0.05); color: var(--primary); font-weight: 700; font-size: 0.85rem; }

    /* GRID SISWA (DASHBOARD AWAL) */
    .grid-siswa { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; }
    .card-siswa { background: var(--glass); border: 1px solid var(--border); padding: 20px 10px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
    .card-siswa:hover { border-color: var(--primary); background: rgba(14,165,233,0.1); }
    .card-siswa span { font-size: 2.5rem; display: block; margin-bottom: 10px; }
    .card-siswa p { font-size: 0.7rem; font-weight: 700; line-height: 1.3; }

    /* PANEL FULLSCREEN (GURU & KERJA) */
    .panel-overlay { 
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: #030712; z-index: 5000; overflow-y: auto; padding: 30px 20px;
    }

    /* MENU GURU (BENTO STYLE) */
    .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .bento-card { 
      background: #111827; border: 1px solid var(--border); padding: 20px; 
      border-radius: 24px; cursor: pointer; display: flex; flex-direction: column; gap: 10px;
    }
    .bento-card .icon { font-size: 1.5rem; }
    .bento-card h4 { font-size: 0.9rem; }

    /* CBT INTERFACE */
    .nomor-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; justify-content: center; }
    .btn-nomor { width: 38px; height: 38px; border-radius: 10px; border: 1px solid #374151; background: #1f2937; color: white; font-weight: 700; cursor: pointer; }
    .btn-nomor.active { background: var(--primary); border-color: var(--primary); }
    .btn-nomor.filled { background: #10b981; border-color: #10b981; }

    .soal-box { background: white; color: #1e293b; padding: 25px; border-radius: 20px; margin-bottom: 20px; }
    .opsi-btn { 
      padding: 15px; border: 2px solid #f1f5f9; border-radius: 12px; margin-bottom: 10px; 
      cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px;
    }
    .opsi-btn.selected { border-color: var(--primary); background: #f0f9ff; color: var(--primary); }

    /* FORM BUAT SOAL */
    .form-soal-item { background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; color: #1e293b; }
    input, textarea, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; margin: 8px 0; font-size: 0.9rem; }
    .btn-action { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>

<div class="container" id="mainDashboard">
  <div class="brand-header">
    <p style="color: var(--primary); font-weight: 700; letter-spacing: 2px; font-size: 0.7rem; margin-bottom: 5px;">SD N PENGKOL</p>
    <h1>RUANG BELAJAR</h1>
  </div>

  <div class="info-bar">
    <div style="font-size: 0.7rem; color: #94a3b8;">LMS KELAS V ‚Ä¢ 2025/2026</div>
    <div class="guru-profile" onclick="openLogin()">
      <div style="text-align: right; line-height: 1.2;">
        <p style="font-size: 0.7rem; font-weight: 700;">Aditya W. W., S.Pd</p>
        <p style="font-size: 0.5rem; opacity: 0.6;">Guru Kelas V</p>
      </div>
      <img src="https://ui-avatars.com/api/?name=Aditya+WW&background=0ea5e9&color=fff">
    </div>
  </div>

  <div id="statusTugas" class="banner">Mengecek Tugas...</div>
  <div class="grid-siswa" id="gridSiswa"></div>
</div>

<div id="panelGuru" class="panel-overlay">
  <div class="container" style="max-width: 500px;">
    <h2 style="text-align:center; margin-bottom: 20px;">MENU GURU</h2>
    <div class="bento-grid">
      <div class="bento-card" onclick="openView('panelBuat')">
        <span class="icon">üìù</span>
        <h4>Buat Tugas</h4>
      </div>
      <div class="bento-card" onclick="openView('panelRekap')">
        <span class="icon">üìä</span>
        <h4>Rekap Nilai</h4>
      </div>
      <div class="bento-card" style="border-color: #ef4444;" onclick="resetTugas()">
        <span class="icon">üóëÔ∏è</span>
        <h4 style="color: #ef4444;">Hapus Tugas</h4>
      </div>
      <div class="bento-card" onclick="location.reload()">
        <span class="icon">üö™</span>
        <h4>Keluar</h4>
      </div>
    </div>
  </div>
</div>

<div id="panelKerja" class="panel-overlay" style="background: #f8fafc; color: #1e293b;">
  <div class="container" style="max-width: 600px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h4 id="namaSiswaHi" style="color: #64748b;"></h4>
      <button onclick="closeAllPanels()" style="border:none; background:none; color:red; font-weight:800;">BATAL</button>
    </div>
    <div class="nomor-grid" id="nomorGrid"></div>
    <div class="soal-box">
      <div id="soalKe" style="color: var(--primary); font-weight: 800; font-size: 0.7rem; margin-bottom: 5px;"></div>
      <p id="isiSoalTeks" style="font-size: 1.1rem; font-weight: 700; margin-bottom: 20px;"></p>
      <div id="isiOpsi"></div>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn-action" style="background:#e2e8f0; color:#475569" onclick="geserSoal(-1)">KEMBALI</button>
      <button class="btn-action" style="background:var(--primary); color:white" onclick="geserSoal(1)">LANJUT</button>
    </div>
    <button id="btnFinish" class="btn-action" style="background:#10b981; color:white; display:none;" onclick="prosesSelesai()">KIRIM JAWABAN</button>
  </div>
</div>

<div id="panelBuat" class="panel-overlay" style="background: #f1f5f9; color: #1e293b;">
  <div class="container" style="max-width: 500px;">
    <h3 style="margin-bottom:20px;">üìù Setting Tugas Baru</h3>
    <input type="text" id="judulMateri" placeholder="Judul Materi (Contoh: Matematika: Segitiga)">
    <select id="jenisTugas" onchange="resetFormSoal()">
      <option value="pg">Pilihan Ganda (A-D)</option>
      <option value="uraian">Uraian / Essay</option>
    </select>
    <div id="wadahSoal"></div>
    <button class="btn-action" style="background:#94a3b8; color:white" onclick="tambahSoalItem()">+ Tambah Soal</button>
    <button class="btn-action" style="background:var(--primary); color:white" onclick="terbitkanTugas()">TERBITKAN TUGAS</button>
    <button class="btn-action" style="background:#ef4444; color:white" onclick="closeView('panelBuat')">KEMBALI</button>
  </div>
</div>

<div id="modalLogin" class="panel-overlay" style="background: rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center;">
  <div style="background:#1f2937; padding:30px; border-radius:24px; width:300px; text-align:center;">
    <h4 style="margin-bottom:20px;">PIN GURU</h4>
    <input type="password" id="pinInput" placeholder="****" style="text-align:center; font-size:1.5rem; letter-spacing:5px;">
    <button class="btn-action" style="background:var(--primary); color:white" onclick="cekLogin()">MASUK</button>
    <button style="background:none; border:none; color:#94a3b8; margin-top:15px; cursor:pointer;" onclick="closeAllPanels()">Batal</button>
  </div>
</div>

<canvas id="canvasHasil" style="display:none;"></canvas>

<script>
const API = "https://script.google.com/macros/s/AKfycbzKSeF0P2w2x1sszm09pLl1lEzApYHH9xbG1UISa5SoiDWfrle5L4iF7jbh8LtdqgyHvA/exec";
const SISWA = [{n:"Alvaro Adnan Aji Pambudi",i:"üë¶"},{n:"Anantha Yudha Diztira",i:"üë¶"},{n:"Arifah Yhuan Nur Azizah",i:"üëß"},{n:"Aurelia Gieni Lindria Putri",i:"üëß"},{n:"Dhafitha Nizza Nur Azizah",i:"üëß"},{n:"Dhian Rahmawati",i:"üëß"},{n:"Dimas Rasyid Faristia",i:"üë¶"},{n:"Erfin Denu Setiawan",i:"üë¶"},{n:"Marsya Anindya Kiera",i:"üëß"},{n:"Mikayla Ayuningtyas",i:"üëß"},{n:"Muhammad Ozil Ramadhan",i:"üë¶"},{n:"Rhevan Nabil Yudanta",i:"üë¶"},{n:"Ridho Wicaksono",i:"üë¶"},{n:"Rizky Syam Dani",i:"üë¶"},{n:"Tanca Al Verosa",i:"üë¶"}];

let dataWeb = null, userSekarang = "", indeksSoal = 0, jawabanSiswa = [];

window.onload = init;

async function init() {
  const grid = document.getElementById('gridSiswa');
  SISWA.forEach(s => { grid.innerHTML += `<div class="card-siswa" onclick="mulaiTugas('${s.n}')"><span>${s.i}</span><p>${s.n}</p></div>`; });
  try {
    const res = await fetch(API + "?action=getAllData");
    dataWeb = await res.json();
    document.getElementById('statusTugas').innerText = dataWeb.tugas.judul === "TIDAK ADA TUGAS" ? "BELUM ADA TUGAS AKTIF" : "TUGAS: " + dataWeb.tugas.judul;
  } catch(e) { document.getElementById('statusTugas').innerText = "Gagal memuat data."; }
}

function mulaiTugas(nama) {
  if(!dataWeb || dataWeb.tugas.judul === "TIDAK ADA TUGAS") return alert("Tidak ada tugas untuk dikerjakan.");
  userSekarang = nama; indeksSoal = 0;
  jawabanSiswa = new Array(dataWeb.tugas.soal.length).fill("");
  document.getElementById('namaSiswaHi').innerText = "Siswa: " + nama;
  document.getElementById('panelKerja').style.display = 'block';
  renderHalamanSoal();
}

function renderHalamanSoal() {
  const s = dataWeb.tugas.soal[indeksSoal];
  document.getElementById('soalKe').innerText = `SOAL NO. ${indeksSoal + 1} DARI ${dataWeb.tugas.soal.length}`;
  document.getElementById('isiSoalTeks').innerText = s.tanya;
  
  const containerOpsi = document.getElementById('isiOpsi');
  containerOpsi.innerHTML = "";
  
  if(dataWeb.tugas.jenis === 'pg') {
    ['A','B','C','D'].forEach((label, i) => {
      const isSel = jawabanSiswa[indeksSoal] === label ? 'selected' : '';
      containerOpsi.innerHTML += `<div class="opsi-btn ${isSel}" onclick="simpanJawaban('${label}')"><b>${label}.</b> ${s.opsi[i]}</div>`;
    });
  } else {
    containerOpsi.innerHTML = `<textarea oninput="simpanJawaban(this.value)" placeholder="Ketik jawabanmu di sini..." style="height:150px">${jawabanSiswa[indeksSoal]}</textarea>`;
  }

  // Render Grid Nomor
  const gridNomor = document.getElementById('nomorGrid');
  gridNomor.innerHTML = "";
  dataWeb.tugas.soal.forEach((_, i) => {
    const stat = (i === indeksSoal) ? 'active' : (jawabanSiswa[i] !== "" ? 'filled' : '');
    gridNomor.innerHTML += `<button class="btn-nomor ${stat}" onclick="lompatNomor(${i})">${i+1}</button>`;
  });

  document.getElementById('btnFinish').style.display = (indeksSoal === dataWeb.tugas.soal.length - 1) ? 'block' : 'none';
}

function simpanJawaban(val) { jawabanSiswa[indeksSoal] = val; renderHalamanSoal(); }
function geserSoal(arah) { let n = indeksSoal + arah; if(n >= 0 && n < dataWeb.tugas.soal.length) { indeksSoal = n; renderHalamanSoal(); } }
function lompatNomor(i) { indeksSoal = i; renderHalamanSoal(); }

// FUNGSI GURU
function openLogin() { document.getElementById('modalLogin').style.display = 'flex'; }
function cekLogin() { if(document.getElementById('pinInput').value === "1234") { closeAllPanels(); openView('panelGuru'); } else alert("PIN Salah!"); }
function openView(id) { document.getElementById(id).style.display = 'block'; }
function closeView(id) { document.getElementById(id).style.display = 'none'; }
function closeAllPanels() { document.querySelectorAll('.panel-overlay').forEach(p => p.style.display = 'none'); }

function tambahSoalItem() {
  const id = Date.now();
  const tipe = document.getElementById('jenisTugas').value;
  const html = `
    <div class="form-soal-item" id="item-${id}">
      <b>Pertanyaan:</b><textarea class="q-text"></textarea>
      ${tipe === 'pg' ? `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
          <input class="oa" placeholder="Opsi A">
          <input class="ob" placeholder="Opsi B">
          <input class="oc" placeholder="Opsi C">
          <input class="od" placeholder="Opsi D">
        </div>
        <b>Kunci:</b><select class="q-kunci"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
      ` : ''}
      <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; font-weight:bold; cursor:pointer;">HAPUS</button>
    </div>`;
  document.getElementById('wadahSoal').insertAdjacentHTML('beforeend', html);
}

function resetFormSoal() { document.getElementById('wadahSoal').innerHTML = ""; tambahSoalItem(); }

async function terbitkanTugas() {
  const btn = event.target; btn.innerText = "PROSES..."; btn.disabled = true;
  const payload = { action: "setTugas", judul: document.getElementById('judulMateri').value, jenis: document.getElementById('jenisTugas').value, soal: [] };
  
  document.querySelectorAll('.form-soal-item').forEach(el => {
    let s = { tanya: el.querySelector('.q-text').value };
    if(payload.jenis === 'pg') {
      s.opsi = [el.querySelector('.oa').value, el.querySelector('.ob').value, el.querySelector('.oc').value, el.querySelector('.od').value];
      s.kunci = el.querySelector('.q-kunci').value;
    }
    payload.soal.push(s);
  });

  await fetch(API, { method: "POST", body: JSON.stringify(payload) });
  alert("Tugas Berhasil Terbit!"); location.reload();
}

async function prosesSelesai() {
  if(!confirm("Kirim jawaban sekarang?")) return;
  const btn = document.getElementById('btnFinish'); btn.innerText = "MENGIRIM..."; btn.disabled = true;
  
  let bnr = 0;
  dataWeb.tugas.soal.forEach((s, i) => { if(dataWeb.tugas.jenis === 'pg' && jawabanSiswa[i] === s.kunci) bnr++; });
  const nilai = dataWeb.tugas.jenis === 'pg' ? Math.round((bnr / dataWeb.tugas.soal.length) * 100) : "Uraian";

  const cvs = document.getElementById('canvasHasil'); const ctx = cvs.getContext('2d');
  cvs.width = 500; cvs.height = 700; ctx.fillStyle = "white"; ctx.fillRect(0,0,500,700);
  ctx.fillStyle = "#0ea5e9"; ctx.fillRect(0,0,500,60); ctx.fillStyle = "white"; ctx.font="bold 20px Arial"; ctx.fillText("HASIL KERJA SISWA", 20, 40);
  ctx.fillStyle = "#1e293b"; ctx.font="bold 14px Arial"; ctx.fillText(`Nama: ${userSekarang}`, 20, 100); ctx.fillText(`Nilai: ${nilai}`, 20, 130);
  let y=180; jawabanSiswa.forEach((j, i) => { ctx.fillText(`No ${i+1}: ${j}`, 30, y); y+=25; });
  const imgData = cvs.toDataURL("image/jpeg", 0.6).split(',')[1];

  await fetch(API, { method: "POST", body: JSON.stringify({ action: "upload", nama: userSekarang, materi: dataWeb.tugas.judul, nilai: nilai, file: imgData, filename: userSekarang + ".jpg" })});
  alert("Berhasil Terkirim!"); location.reload();
}

async function resetTugas() {
  if(confirm("Hapus tugas aktif?")) {
    await fetch(API, { method: "POST", body: JSON.stringify({ action: "setTugas", judul: "TIDAK ADA TUGAS", jenis: "pg", soal: [] }) });
    location.reload();
  }
}
</script>
</body>
</html>
