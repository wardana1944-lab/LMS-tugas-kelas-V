<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RUANG BELAJAR - SD N PENGKOL</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #059669; --accent: #10B981; --bg: #F8FAFC; --white: #FFFFFF; 
      --text: #1E293B; --border: #E2E8F0; --danger: #EF4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
    body { background: var(--bg); color: var(--text); overflow-x: hidden; }

    header {
      background: var(--primary); color: white; padding: 60px 20px;
      text-align: center; border-radius: 0 0 50px 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .container { max-width: 1000px; margin: -40px auto 40px; padding: 0 20px; }

    .guru-profile {
      background: var(--white); padding: 25px; border-radius: 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid var(--border);
    }
    .guru-info { display: flex; align-items: center; gap: 15px; }
    .guru-avatar-img { 
      width: 65px; height: 65px; border-radius: 50%; object-fit: cover; 
      border: 3px solid #D1FAE5; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .grid-siswa { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
    .card-siswa {
      background: var(--white); padding: 25px; border-radius: 24px;
      text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid var(--border);
    }
    .card-siswa:hover { transform: translateY(-5px); border-color: var(--accent); }

    /* TAMPILAN PILIH TUGAS (Sesuai Gambar Bapak) */
    .welcome-section { text-align: center; padding: 40px 20px; }
    .student-avatar-big {
      width: 100px; height: 100px; background: #D1FAE5; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;
      font-size: 3rem; border: 4px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    .btn-tugas-item {
      background: #f1f5f9; padding: 20px; border-radius: 15px; margin-bottom: 12px;
      cursor: pointer; transition: 0.2s; border: 1px solid transparent; font-weight: 600;
    }
    .btn-tugas-item:hover { background: white; border-color: var(--accent); color: var(--primary); }

    .panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; overflow-y: auto; }
    .panel-content { max-width: 700px; margin: 40px auto; padding: 0 20px; }
    
    .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-blue { background: var(--accent); color: white; }
    .btn-dark { background: var(--primary); color: white; }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }

    .soal-box { background: white; padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
    textarea { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--border); min-height: 100px; margin-top: 10px; }
  </style>
</head>
<body>

<header>
  <h1>RUANG BELAJAR</h1>
  <p>SD NEGERI PENGKOL</p>
  <p>Tahun Pelajaran 2025/2026</p>
</header>

<div class="container" id="mainHome">
  <div class="guru-profile">
    <div class="guru-info">
      <img src="https://lh3.googleusercontent.com/u/0/d/1USZehHQREodLN016Fp8AC2_8gsTobW4W" class="guru-avatar-img">
      <div>
        <h3>Aditya W. Wardana, S.Pd</h3>
        <p style="font-size: 0.8rem; color: var(--text-light);">NIP 19940319 202321 1 005</p>
      </div>
    </div>
    <button class="btn btn-dark" onclick="showLogin()">LOGIN GURU</button>
  </div>
  <div class="grid-siswa" id="gridSiswa"></div>
</div>

<div id="panelPilihTugas" class="panel">
  <div class="panel-content welcome-section">
    <div class="student-avatar-big" id="avatarBesar">ðŸ‘¦</div>
    <h2 id="salamSiswa" style="color: var(--primary); margin-bottom: 5px;">Halo, Alvaro!</h2>
    <p style="color: #64748b; margin-bottom: 30px;">Silakan pilih tugas yang ingin dikerjakan hari ini:</p>
    
    <div id="listTugasSiswa"></div>

    <button class="btn btn-outline" style="width: 100%; margin-top: 20px;" onclick="location.reload()">Bukan saya, kembali</button>
  </div>
</div>

<div id="panelSiswa" class="panel">
  <div class="panel-content">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <div id="timer" style="background:var(--primary); color:white; padding:8px 15px; border-radius:10px; font-weight:bold;">00:00</div>
        <div id="nomorSkrg" style="font-weight:bold;">Soal 1</div>
    </div>
    <div class="soal-box">
      <div id="gbrSoal"></div>
      <h3 id="txtSoal"></h3>
      <div id="opsiJawaban" style="margin-top:20px;"></div>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-outline" style="flex:1" onclick="geser(-1)">KEMBALI</button>
      <button class="btn btn-blue" style="flex:1" id="btnLanjut" onclick="geser(1)">LANJUT</button>
    </div>
    <button class="btn btn-dark" id="btnKirim" style="width:100%; margin-top:15px; display:none;" onclick="kirimJawaban()">KIRIM JAWABAN</button>
  </div>
</div>

<script>
// --- KONFIGURASI FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyCfzJJpq32AltXRcP0ZB6fM1mvYpJVSVl4",
  authDomain: "ruang-belajar-kelas-v.firebaseapp.com",
  projectId: "ruang-belajar-kelas-v",
  databaseURL: "https://ruang-belajar-kelas-v-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const SISWA = ["Alvaro Adnan Aji Pambudi", "Anantha Yudha Diztira", "Arifah Yhuan Nur Azizah", "Aurelia Gieni Lindria Putri", "Dhafitha Nizza Nur Azizah", "Dhian Rahmawati", "Dimas Rasyid Faristia", "Erfin Denu Setiawan", "Marsya Anindya Kiera", "Mikayla Ayuningtyas", "Muhammad Ozil Ramadhan", "Rhevan Nabil Yudanta", "Ridho Wicaksono", "Rizky Syam Dani", "Tanca Al Verosa"];

let curUser = "", curTugas = null, curIdx = 0, jawaban = [], detik = 0, timer;

// Munculkan Daftar Siswa
const grid = document.getElementById('gridSiswa');
SISWA.forEach(s => {
  const d = document.createElement('div');
  d.className = 'card-siswa';
  d.innerHTML = `<div style="font-size:2rem; margin-bottom:10px;">${s.includes('Putri')||s.includes('Azizah')||s.includes('Rahmawati')?'ðŸ‘§':'ðŸ‘¦'}</div><div style="font-weight:bold; font-size:0.9rem;">${s}</div>`;
  d.onclick = () => pilihSiswa(s);
  grid.appendChild(d);
});

function pilihSiswa(nama) {
  curUser = nama;
  document.getElementById('salamSiswa').innerText = `Halo, ${nama.split(' ')[0]}!`;
  document.getElementById('avatarBesar').innerText = nama.includes('Putri')||nama.includes('Azizah')||nama.includes('Rahmawati')?'ðŸ‘§':'ðŸ‘¦';
  
  // Ambil Tugas dari Firebase
  db.ref('tugas_multi').once('value', snap => {
    const list = document.getElementById('listTugasSiswa');
    list.innerHTML = "";
    if(!snap.exists()) {
      list.innerHTML = `<div class="btn-tugas-item" style="cursor:default">Belum ada tugas aktif dari Pak Aditya.</div>`;
    } else {
      snap.forEach(t => {
        const item = document.createElement('div');
        item.className = 'btn-tugas-item';
        item.innerText = t.val().judul;
        item.onclick = () => mulaiTugas(t.val());
        list.appendChild(item);
      });
    }
    document.getElementById('panelPilihTugas').style.display = 'block';
  });
}

function mulaiTugas(t) {
  curTugas = t;
  curIdx = 0;
  jawaban = new Array(t.soal.length).fill("");
  detik = t.durasi * 60;
  document.getElementById('panelPilihTugas').style.display = 'none';
  document.getElementById('panelSiswa').style.display = 'block';
  jalankanTimer();
  renderSoal();
}

function renderSoal() {
  const s = curTugas.soal[curIdx];
  document.getElementById('nomorSkrg').innerText = `Soal ${curIdx + 1} / ${curTugas.soal.length}`;
  document.getElementById('txtSoal').innerHTML = s.tanya;
  document.getElementById('gbrSoal').innerHTML = s.gambar ? `<img src="${s.gambar}" style="max-width:100%; border-radius:15px; margin-bottom:15px;">` : "";
  
  const wadahOpsi = document.getElementById('opsiJawaban');
  wadahOpsi.innerHTML = "";

  if(s.jenis === "PG") {
    s.opsi.forEach((o, i) => {
      const char = String.fromCharCode(65+i);
      const btn = document.createElement('div');
      btn.className = `btn-tugas-item ${jawaban[curIdx] === char ? 'selected' : ''}`;
      btn.style.textAlign = "left";
      btn.style.background = jawaban[curIdx] === char ? '#D1FAE5' : '#f1f5f9';
      btn.innerHTML = `<b>${char}.</b> ${o}`;
      btn.onclick = () => { jawaban[curIdx] = char; renderSoal(); };
      wadahOpsi.appendChild(btn);
    });
  } else {
    const area = document.createElement('textarea');
    area.placeholder = "Ketik jawabanmu di sini...";
    area.value = jawaban[curIdx];
    area.oninput = (e) => { jawaban[curIdx] = e.target.value; };
    wadahOpsi.appendChild(area);
  }

  document.getElementById('btnLanjut').style.display = curIdx === curTugas.soal.length - 1 ? 'none' : 'block';
  document.getElementById('btnKirim').style.display = curIdx === curTugas.soal.length - 1 ? 'block' : 'none';
}

function geser(n) {
  if(curIdx + n >= 0 && curIdx + n < curTugas.soal.length) {
    curIdx += n;
    renderSoal();
  }
}

function jalankanTimer() {
  timer = setInterval(() => {
    detik--;
    let m = Math.floor(detik/60);
    let s = detik % 60;
    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
    if(detik <= 0) kirimJawaban();
  }, 1000);
}

async function kirimJawaban() {
  if(!confirm("Kirim jawaban sekarang?")) return;
  clearInterval(timer);
  
  // GENERATE PDF PROFESIONAL (TABEL)
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  doc.setFontSize(14); doc.text("LEMBAR JAWABAN SISWA", 105, 15, {align:"center"});
  doc.setFontSize(10); doc.text(`Nama: ${curUser} | Tugas: ${curTugas.judul}`, 20, 25);
  
  const tabelData = [];
  curTugas.soal.forEach((s, i) => {
    tabelData.push([i+1, s.tanya.replace(/<\/?[^>]+(>|$)/g, ""), jawaban[i] || "-"]);
  });

  doc.autoTable({
    startY: 30,
    head: [['No', 'Pertanyaan', 'Jawaban Anda']],
    body: tabelData,
    headStyles: { fillColor: [5, 150, 105] },
    theme: 'grid'
  });

  const pdfBase64 = doc.output('datauristring').split(',')[1];

  // Simpan ke Rekap
  db.ref('rekap_v2').push({
    nama: curUser,
    materi: curTugas.judul,
    file: pdfBase64,
    waktu: new Date().toLocaleString()
  }).then(() => {
    alert("Jawaban terkirim! Terima kasih.");
    location.reload();
  });
}

function showLogin() {
  const pin = prompt("Masukkan PIN Guru:");
  if(pin === "1234") alert("Fitur Dashboard Guru aktif (silakan tambahkan panel guru Bapak)");
}
</script>
</body>
</html>
