// 1. Tombol Hapus Soal (Tambahkan fungsi ini)
function tambahSoal() { 
    const id = Date.now(); // ID unik untuk setiap soal
    const d = document.createElement('div'); 
    d.className='card-soal';
    d.id = 'soal-' + id;
    d.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <b>Pertanyaan:</b>
            <button onclick="hapusSoal('soal-${id}')" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:8px; cursor:pointer; font-size:0.7rem;">Hapus Soal</button>
        </div>
        <textarea class="q-t" style="height:60px"></textarea>`;
    
    if(document.getElementById('tipeTugas').value==='pg') {
        d.innerHTML += `<input class="o-a" placeholder="Opsi A"> <input class="o-b" placeholder="Opsi B">`;
    }
    document.getElementById('builder').appendChild(d);
}

function hapusSoal(id) {
    const el = document.getElementById(id);
    if(el) el.remove();
}

// 2. Percepat Loading (Optimasi muatData)
async function muatData() {
    const banner = document.getElementById('bannerTugas');
    banner.innerHTML = "Menghubungkan ke server...";
    
    try {
        // Kita pakai cache: no-cache agar data selalu fresh tapi cepat
        const res = await fetch(API + "?action=getAllData", { cache: "no-cache" });
        const data = await res.json();
        tugasAktif = data.tugas;
        const dataRekap = data.rekap;

        // Banner Status
        if (!tugasAktif.judul || tugasAktif.judul === "TIDAK ADA TUGAS") {
            banner.innerHTML = `<div class="status-banner" style="color:#ef4444; border-color:#ef4444">TIDAK ADA TUGAS AKTIF</div>`;
        } else {
            banner.innerHTML = `<div class="status-banner">TUGAS AKTIF: ${tugasAktif.judul}</div>`;
        }
        
        // Render Grid Siswa
        const grid = document.getElementById('gridSiswa'); 
        grid.innerHTML = "";
        
        // Buat set untuk pencarian cepat
        const sdhMengerjakan = new Set(dataRekap.filter(r => r.materi === tugasAktif.judul).map(r => r.nama));

        SISWA.forEach(s => {
            const sudah = sdhMengerjakan.has(s.n);
            grid.innerHTML += `
                <div class="student-card" onclick="bukaPengerjaan('${s.n}')">
                    <div class="status-badge ${sudah?'s-sudah':'s-belum'}">${sudah?'Selesai':'Belum'}</div>
                    <span style="font-size:2.5rem">${s.i}</span>
                    <p style="font-size:0.8rem; font-weight:bold; margin-top:10px; line-height:1.2">${s.n}</p>
                </div>`;
        });

        // Render Tabel Rekap
        const body = document.getElementById('bodyRekap'); 
        body.innerHTML = "";
        dataRekap.slice(-20).reverse().forEach(rd => { // Hanya ambil 20 data terakhir agar ringan
            body.innerHTML += `<tr><td>${rd.nama}</td><td>âœ…</td><td>${rd.materi}</td><td><a href="https://drive.google.com/uc?id=${rd.link}" target="_blank" style="color:#38bdf8; text-decoration:none; font-weight:bold;">LIHAT</a></td></tr>`;
        });

    } catch(e) { 
        banner.innerHTML = `<div class="status-banner" style="color:red">Koneksi Lambat. Sila muat ulang halaman.</div>`;
    }
}
