<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RUANG BELAJAR - SD N PENGKOL</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #059669; --accent: #10B981; --primary-dark: #064E3B;
      --bg: #F8FAFC; --white: #FFFFFF; --text: #1E293B; --text-light: #64748B;
      --border: #E2E8F0; --danger: #EF4444; --header-bg: #059669; --header-text: #FFFFFF; 
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
    body { background: var(--bg); color: var(--text); line-height: 1.6; }

    /* HEADER BARU YANG RAPI */
    header { 
      background: linear-gradient(135deg, #059669 0%, #10B981 100%); 
      color: var(--header-text); 
      padding: 50px 20px; 
      text-align: center; 
      border-radius: 0 0 50px 50px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
    }
    header h1 { 
      font-size: 2.2rem; 
      font-weight: 800; 
      letter-spacing: 2px; 
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    header .school-name {
      font-size: 1.3rem;
      font-weight: 600;
      display: block;
      margin-bottom: 10px;
      opacity: 0.95;
    }
    header .divider {
      width: 50px;
      height: 3px;
      background: white;
      margin: 10px auto;
      border-radius: 2px;
      opacity: 0.7;
    }
    header .year { 
      display: inline-block;
      padding: 5px 20px;
      background: rgba(255,255,255,0.15);
      border-radius: 20px;
      font-size: 0.9rem; 
      font-weight: 400;
      margin-top: 5px;
    }

    .container { max-width: 1000px; margin: -40px auto 40px; padding: 0 20px; }

    .guru-profile { background: var(--white); padding: 25px; border-radius: 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid var(--border); }
    .guru-info { display: flex; align-items: center; gap: 15px; }
    .guru-avatar { width: 60px; height: 60px; background: #D1FAE5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--primary); }

    .status-banner { background: #f1f5f9; padding: 12px 20px; border-radius: 12px; margin-bottom: 25px; font-weight: 600; text-align: center; border-left: 5px solid var(--accent); }

    .grid-siswa { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
    .card-siswa { background: var(--white); padding: 30px 20px; border-radius: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--border); }
    .card-siswa:hover { transform: translateY(-8px); border-color: var(--accent); box-shadow: 0 12px 30px rgba(16, 185, 129, 0.1); }
    .card-siswa .icon { font-size: 3rem; margin-bottom: 10px; display: block; }
    .card-siswa .nama { font-weight: 700; font-size: 1rem; }

    .panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; overflow-y: auto; padding: 40px 0; }
    .panel-content { max-width: 800px; margin: 0 auto; padding: 0 20px; }

    .btn { padding: 14px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-blue { background: var(--accent); color: white; }
    .btn-dark { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
    .btn-danger { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 15px; overflow: hidden; border: 1px solid var(--border); }
    th { background: #f1f5f9; padding: 15px; text-align: left; font-size: 0.9rem; }
    td { padding: 15px; border-bottom: 1px solid var(--border); }

    .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .bg-green { background: #dcfce7; color: #166534; }
    .bg-red { background: #fee2e2; color: #991b1b; }

    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin: 8px 0; font-size: 1rem; }
    .soal-box { background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--border); position: relative; }
    
    .opt-box { background: white; border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
    .opt-box:hover { border-color: var(--accent); background: #f0fdf4; }
    .opt-box.selected { background: #D1FAE5; border-color: var(--primary); color: var(--primary); font-weight: 700; }

    .toolbar { background: #f1f5f9; padding: 8px; border-radius: 10px 10px 0 0; border: 1px solid var(--border); border-bottom: none; display: flex; gap: 5px; }
    .btn-tool { padding: 5px 10px; background: white; border: 1px solid #cbd5e1; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-tool:hover { background: #e2e8f0; }
    .editor { min-height: 100px; padding: 12px; border: 1px solid var(--border); border-radius: 0 0 10px 10px; background: white; outline: none; margin-bottom: 10px; }
    .img-preview { max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 8px; display: block; }

    .btn-hapus-soal { position: absolute; top: 15px; right: 15px; background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; padding: 5px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; cursor: pointer; }
    .btn-hapus-soal:hover { background: #ef4444; color: white; }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p id="loaderText" style="margin-top:10px; font-weight:700; color: var(--primary);">Memproses...</p></div>

<header>
  <h1>RUANG BELAJAR</h1>
  <span class="school-name">KELAS V</span>
  <div class="divider"></div>
  <p class="year">SD NEGERI PENGKOL 2025/2026</p>
</header>

<div class="container">
  <div class="guru-profile">
    <div class="guru-info">
      <div class="guru-avatar">üë®‚Äçüè´</div>
      <div>
        <h3 style="font-size: 0.9rem;">Aditya W. Wardana., S.Pd</h3>
        <p style="font-size: 0.7rem; color: #64748b;">NIP 19940319 202321 1 005</p>
        <p style="font-size: 0.7rem; color: #64748b;">Wali Kelas V</p>
      </div>
    </div>
    <button class="btn btn-dark" onclick="openView('modalLogin')">LOGIN GURU</button>
  </div>

  <div id="listTugasAktif" class="status-banner">Memuat data...</div>

  <div class="grid-siswa" id="gridSiswa"></div>
</div>

<div id="modalLogin" class="panel" style="background:rgba(15,23,42,0.8); align-items:center; justify-content:center; display:none;">
    <div style="background:white; padding:40px; border-radius:30px; width:100%; max-width:350px; text-align:center;">
      <h2 style="margin-bottom:20px;">Akses Guru</h2>
      <input type="password" id="pin" placeholder="Password" style="text-align:center; font-size: 1 rem; letter-spacing: 5px;">
      <button class="btn btn-blue" style="width:100%; margin-top:15px;" onclick="prosesLogin()">MASUK DASHBOARD</button>
      <button class="btn-outline btn" style="width:100%; margin-top:10px; border:none;" onclick="closeView('modalLogin')">Batal</button>
    </div>
</div>

<div id="panelGuru" class="panel">
    <div class="panel-content" style="max-width: 600px;">
      <h2 style="margin-bottom:30px; text-align:center; color: var(--primary);">Dashboard Guru</h2>
      <div class="soal-box">
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <h4 style="color: var(--primary);">TUGAS 1</h4>
              <div id="infoSlot1" style="font-size:0.8rem; font-weight:700;">Kosong</div>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
              <button class="btn btn-blue" onclick="bukaBuatTugas('tugas1')">Buat/Edit</button>
              <button class="btn btn-danger" onclick="hapusTugasAktif('tugas1')">Akhiri Tugas</button>
          </div>
      </div>
      <div class="soal-box">
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <h4 style="color: var(--primary);">TUGAS 2</h4>
              <div id="infoSlot2" style="font-size:0.8rem; font-weight:700;">Kosong</div>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
              <button class="btn btn-blue" onclick="bukaBuatTugas('tugas2')">Buat/Edit</button>
              <button class="btn btn-danger" onclick="hapusTugasAktif('tugas2')">Akhiri Tugas</button>
          </div>
      </div>
      <button class="btn btn-dark" style="width:100%;" onclick="openView('panelRekap')">üìä LIHAT REKAPITULASI NILAI</button>
      <button class="btn-outline btn" style="width:100%; margin-top:15px;" onclick="closeView('panelGuru')">Keluar</button>
    </div>
</div>

<div id="panelBuat" class="panel">
    <div class="panel-content">
      <h3 id="labelTugas" style="color: var(--primary);">Konfigurasi Soal</h3>
      <input type="text" id="jdlMateri" placeholder="Judul Tugas (Contoh: Evaluasi Matematika)">
      <input type="number" id="waktuTugas" placeholder="Waktu (Menit)" value="60">
      <div id="wadahInput" style="margin-top:20px;"></div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <button class="btn btn-outline" onclick="tambahSoal('PG')">+ Pilihan Ganda</button>
          <button class="btn btn-outline" onclick="tambahSoal('URAIAN')">+ Soal Uraian</button>
      </div>
      <button class="btn btn-blue" style="width:100%; margin-top:30px;" onclick="simpanKeFirebase()">TERBITKAN TUGAS SEKARANG</button>
      <button class="btn-outline btn" style="width:100%; margin-top:10px; border:none;" onclick="closeView('panelBuat')">Batal</button>
    </div>
</div>

<div id="panelRekap" class="panel">
    <div class="panel-content">
      <h2 style="margin-bottom:20px;">Rekapitulasi Nilai</h2>
      <select id="filterTugas" onchange="filterRekap()" style="margin-bottom:20px; font-weight:700; border-color: var(--primary);">
          <option value="">-- Pilih Judul Tugas --</option>
      </select>
      <div style="overflow-x:auto;">
          <table>
              <thead><tr><th>No</th><th>Nama Lengkap</th><th>Status</th><th>Nilai PG</th><th>Aksi</th></tr></thead>
              <tbody id="isiRekap"></tbody>
          </table>
      </div>
      <button class="btn btn-outline" style="width:100%; margin-top:30px;" onclick="closeView('panelRekap')">KEMBALI</button>
    </div>
</div>

<div id="panelPilihTugas" class="panel">
    <div class="panel-content" style="max-width:500px; text-align:center;">
      <div class="guru-avatar" style="margin: 0 auto 20px; width:80px; height:80px; font-size:2.5rem; background: #D1FAE5;">üë¶</div>
      <h2 id="salamSiswa" style="color: var(--primary);">Selamat Datang</h2>
      <p style="color:#64748b; margin-bottom:30px;">Pilih tugas yang ingin dikerjakan:</p>
      <div id="menuTugasSiswa"></div>
      <button class="btn btn-outline" style="width:100%; margin-top:20px;" onclick="location.reload()">KELUAR</button>
    </div>
</div>

<div id="panelSiswa" class="panel">
    <div class="panel-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <button class="btn btn-outline" style="padding:8px 15px; font-size: 0.8rem;" onclick="kembaliKeDaftarTugas()">‚¨ÖÔ∏è Daftar Tugas</button>
          <div id="displayTimer" style="background:var(--primary); color:white; padding:8px 20px; border-radius:10px; font-weight:800;">00:00</div>
      </div>
      <div id="gridNomorCBT" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:25px;"></div>
      <div class="soal-box">
        <div id="imgSoalSiswa"></div>
        <div id="teksSoal" style="margin-bottom:20px; font-size: 1.1rem; color: var(--text);"></div>
        <div id="areaJawaban"></div>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
        <button class="btn btn-outline" onclick="pindahSoal(-1)">KEMBALI</button>
        <button class="btn btn-blue" onclick="pindahSoal(1)">LANJUTKAN</button>
      </div>
      <div id="divKirim" style="display:none; margin-top:25px;">
        <button class="btn btn-dark" style="width:100%;" onclick="submitJawaban()">KIRIM JAWABAN SAYA</button>
      </div>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCfzJJpq32AltXRcP0ZB6fM1mvYpJVSVl4",
  authDomain: "ruang-belajar-kelas-v.firebaseapp.com",
  projectId: "ruang-belajar-kelas-v",
  databaseURL: "https://ruang-belajar-kelas-v-default-rtdb.asia-southeast1.firebasedatabase.app"
};
if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.database();

const SISWA = [
    {n:"Alvaro Adnan Aji Pambudi",i:"üë¶"}, {n:"Anantha Yudha Diztira",i:"üë¶"}, 
    {n:"Arifah Yhuan Nur Azizah",i:"üëß"}, {n:"Aurelia Gieni Lindria Putri",i:"üëß"},
    {n:"Dhafitha Nizza Nur Azizah",i:"üëß"}, {n:"Dhian Rahmawati",i:"üëß"},
    {n:"Dimas Rasyid Faristia",i:"üë¶"}, {n:"Erfin Denu Setiawan",i:"üë¶"},
    {n:"Marsya Anindya Kiera",i:"üëß"}, {n:"Mikayla Ayuningtyas",i:"üëß"},
    {n:"Muhammad Ozil Ramadhan",i:"üë¶"}, {n:"Rhevan Nabil Yudanta",i:"üë¶"},
    {n:"Ridho Wicaksono",i:"üë¶"}, {n:"Rizky Syam Dani",i:"üë¶"},
    {n:"Tanca Al Verosa",i:"üë¶"}
];

let dataTugas = {}, curSlot = "", curUser = "", curIdx = 0, curAns = [], timerInterval, sisaWaktu, rekapGlobal = [];

window.onload = () => {
    const g = document.getElementById('gridSiswa');
    SISWA.forEach(s => {
        const d = document.createElement('div');
        d.className = 'card-siswa';
        d.innerHTML = `<span class="icon">${s.i}</span><p class="nama">${s.n}</p>`;
        d.onclick = () => masukHalamanPilihTugas(s.n);
        g.appendChild(d);
    });

    db.ref('tugas_multi').on('value', (snap) => {
        dataTugas = snap.val() || {};
        const labels = Object.values(dataTugas).map(t => t.judul);
        document.getElementById('listTugasAktif').innerHTML = labels.length > 0 ? "üìù Tugas Aktif:<br>" + labels.join("<br>") : "‚õî Belum Ada Tugas Aktif";
        document.getElementById('infoSlot1').innerText = dataTugas.tugas1 ? dataTugas.tugas1.judul : "Kosong";
        document.getElementById('infoSlot2').innerText = dataTugas.tugas2 ? dataTugas.tugas2.judul : "Kosong";
    });

    db.ref('rekap_v2').on('value', (snap) => {
        rekapGlobal = []; const semuaJudul = new Set();
        snap.forEach(c => { const val = c.val(); rekapGlobal.push(val); if(val.materi) semuaJudul.add(val.materi); });
        const sel = document.getElementById('filterTugas');
        sel.innerHTML = '<option value="">-- Pilih Judul Tugas --</option>';
        semuaJudul.forEach(j => sel.innerHTML += `<option value="${j}">${j}</option>`);
    });
};

function prosesLogin() {
    if(document.getElementById('pin').value === "guru123") {
        closeView('modalLogin'); openView('panelGuru');
        document.getElementById('pin').value = "";
    } else alert("PIN Salah!");
}

function bukaBuatTugas(slot) {
    curSlot = slot;
    document.getElementById('wadahInput').innerHTML = "";
    document.getElementById('jdlMateri').value = dataTugas[slot] ? dataTugas[slot].judul : "";
    if(dataTugas[slot] && dataTugas[slot].soal) {
        dataTugas[slot].soal.forEach(s => { tambahSoalManual(s); });
    }
    openView('panelBuat');
}

function formatDoc(cmd) { document.execCommand(cmd, false, null); }
function insertImage(input, previewId) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById(previewId).src = e.target.result;
        document.getElementById(previewId).style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function tambahSoal(jenis) {
    const wadah = document.getElementById('wadahInput');
    const no = wadah.children.length + 1;
    buatElemenSoal(no, jenis, {tanya: "", img: "", opsi: ["","","",""], kunci: "A"});
}

function tambahSoalManual(data) {
    const wadah = document.getElementById('wadahInput');
    const no = wadah.children.length + 1;
    buatElemenSoal(no, data.jenis, data);
}

function buatElemenSoal(no, jenis, data) {
    const wadah = document.getElementById('wadahInput');
    const div = document.createElement('div');
    div.className = "soal-box"; div.dataset.jenis = jenis;
    
    let html = `<button class="btn-hapus-soal" onclick="hapusSoal(this)">HAPUS</button>
    <b class="label-nomor">No ${no} (${jenis})</b>
    <div class="toolbar">
        <button class="btn-tool" onclick="formatDoc('bold')">B</button>
        <button class="btn-tool" onclick="formatDoc('italic')">I</button>
        <button class="btn-tool" onclick="formatDoc('underline')">U</button>
        <label class="btn-tool" style="font-size:0.8rem;">üñºÔ∏è Gambar <input type="file" hidden onchange="insertImage(this, 'prev-${no}')" accept="image/*"></label>
    </div>
    <div class="editor" id="ed-${no}" contenteditable="true">${data.tanya || ''}</div>
    <img id="prev-${no}" src="${data.img || ''}" class="img-preview" style="display:${data.img ? 'block' : 'none'};">`;
    
    if(jenis === 'PG') {
        const o = data.opsi || ["","","",""];
        html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
            <input class="oa" placeholder="Opsi A" value="${o[0]}"> <input class="ob" placeholder="Opsi B" value="${o[1]}">
            <input class="oc" placeholder="Opsi C" value="${o[2]}"> <input class="od" placeholder="Opsi D" value="${o[3]}">
        </div>
        <select class="q-kunci">
            <option value="A" ${data.kunci === 'A' ? 'selected' : ''}>Kunci: A</option>
            <option value="B" ${data.kunci === 'B' ? 'selected' : ''}>Kunci: B</option>
            <option value="C" ${data.kunci === 'C' ? 'selected' : ''}>Kunci: C</option>
            <option value="D" ${data.kunci === 'D' ? 'selected' : ''}>Kunci: D</option>
        </select>`;
    }
    div.innerHTML = html; wadah.appendChild(div);
}

function hapusSoal(btn) {
    if(confirm("Hapus soal ini?")) {
        btn.parentElement.remove();
        document.querySelectorAll('#wadahInput .soal-box').forEach((box, i) => {
            const noBaru = i + 1;
            box.querySelector('.label-nomor').innerText = `No ${noBaru} (${box.dataset.jenis})`;
        });
    }
}

function simpanKeFirebase() {
    const jdl = document.getElementById('jdlMateri').value;
    if(!jdl) return alert("Judul wajib diisi!");
    showLoader("Mempublikasikan...");
    const soalArr = [];
    document.querySelectorAll('#wadahInput .soal-box').forEach((b, i) => {
        const item = { 
            jenis: b.dataset.jenis, 
            tanya: b.querySelector('.editor').innerHTML,
            img: b.querySelector('.img-preview').src || ""
        };
        if(item.jenis === 'PG') {
            item.opsi = [b.querySelector('.oa').value, b.querySelector('.ob').value, b.querySelector('.oc').value, b.querySelector('.od').value];
            item.kunci = b.querySelector('.q-kunci').value;
        }
        soalArr.push(item);
    });
    db.ref('tugas_multi/' + curSlot).set({ judul: jdl, durasi: document.getElementById('waktuTugas').value, soal: soalArr }).then(() => {
        hideLoader(); alert("Tugas Berhasil Terbit!"); closeView('panelBuat');
    });
}

function filterRekap() {
    const filter = document.getElementById('filterTugas').value;
    const tb = document.getElementById('isiRekap'); tb.innerHTML = "";
    SISWA.forEach((s, idx) => {
        const d = rekapGlobal.find(r => r.nama === s.n && r.materi === filter);
        tb.innerHTML += `<tr><td>${idx+1}</td><td><b>${s.n}</b></td><td><span class="badge ${d ? 'bg-green' : 'bg-red'}">${d ? 'Selesai' : 'Belum'}</span></td><td>${d ? d.nilai : "-"}</td><td>${d ? `<button onclick="viewPDF('${d.file}')" style="color:var(--primary); font-weight:700; background:none; border:none; cursor:pointer;">LIHAT PDF</button>` : "-"}</td></tr>`;
    });
}

function masukHalamanPilihTugas(nama) {
    curUser = nama; document.getElementById('salamSiswa').innerText = "Halo, " + nama.split(' ')[0] + "!";
    const menu = document.getElementById('menuTugasSiswa'); menu.innerHTML = "";
    Object.keys(dataTugas).forEach(slot => {
        const t = dataTugas[slot]; const sudah = rekapGlobal.some(r => r.nama === curUser && r.materi === t.judul);
        const btn = document.createElement('div'); btn.className = "card-siswa"; btn.style = "margin-bottom:15px; padding:20px; display:flex; justify-content:space-between; align-items:center;";
        btn.innerHTML = `<div><h4 style="text-align:left;">${t.judul}</h4><span class="badge ${sudah ? 'bg-green' : 'bg-red'}">${sudah ? 'Sudah Dikerjakan' : 'Belum Dikerjakan'}</span></div>`;
        if(!sudah) btn.onclick = () => mulaiKerja(slot);
        menu.appendChild(btn);
    });
    openView('panelPilihTugas');
}

function mulaiKerja(slot) {
    const t = dataTugas[slot]; curSlot = slot; curIdx = 0; curAns = new Array(t.soal.length).fill("");
    sisaWaktu = t.durasi * 60; openView('panelSiswa'); startTimer(); renderSoal();
}

function renderSoal() {
    const s = dataTugas[curSlot].soal[curIdx];
    document.getElementById('teksSoal').innerHTML = `${curIdx + 1}. ${s.tanya}`;
    document.getElementById('imgSoalSiswa').innerHTML = s.img ? `<img src="${s.img}" style="max-width:100%; border-radius:10px; margin-bottom:15px;">` : "";
    const g = document.getElementById('gridNomorCBT'); g.innerHTML = "";
    curAns.forEach((a, i) => {
        const d = document.createElement('div');
        d.style = `width:35px; height:35px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:0.8rem; cursor:pointer; font-weight:800; border: 2px solid ${curIdx === i ? 'var(--accent)' : (a !== "" ? 'var(--primary)' : '#ddd')}; background:${curIdx === i ? 'var(--accent)' : (a !== "" ? 'var(--primary)' : 'white')}; color:${(curIdx === i || a !== "") ? 'white' : 'black'}`;
        d.innerText = i + 1; d.onclick = () => { curIdx = i; renderSoal(); };
        g.appendChild(d);
    });
    const area = document.getElementById('areaJawaban'); area.innerHTML = "";
    if(s.jenis === 'PG') {
        s.opsi.forEach((o, i) => {
            const char = String.fromCharCode(65 + i);
            const b = document.createElement('div'); b.className = `opt-box ${curAns[curIdx] === char ? 'selected' : ''}`;
            b.innerHTML = `<div style="width:30px; height:30px; border-radius:50%; border:2px solid currentColor; display:flex; align-items:center; justify-content:center;">${char}</div> <span>${o}</span>`;
            b.onclick = () => { curAns[curIdx] = char; renderSoal(); };
            area.appendChild(b);
        });
    } else {
        const tx = document.createElement('textarea'); tx.placeholder = "Ketik jawaban Anda..."; tx.style = "width:100%; height:120px; padding:10px; border-radius:10px;"; tx.value = curAns[curIdx];
        tx.oninput = (e) => curAns[curIdx] = e.target.value; area.appendChild(tx);
    }
    document.getElementById('divKirim').style.display = (curIdx === dataTugas[curSlot].soal.length - 1) ? 'block' : 'none';
}

function submitJawaban() {
    if(!confirm("Kirim jawaban sekarang?")) return;
    showLoader("Mengirim..."); clearInterval(timerInterval);
    const t = dataTugas[curSlot];
    let benar = 0, totalPG = 0;
    
    t.soal.forEach((s, i) => { if(s.jenis === 'PG') { totalPG++; if(curAns[i] === s.kunci) benar++; }});
    const skor = totalPG > 0 ? Math.round((benar / totalPG) * 100) : "Uraian";
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18); doc.setTextColor(5, 150, 105);
    doc.text("LAPORAN HASIL TUGAS SISWA", 105, 20, {align: 'center'});
    doc.setFontSize(12); doc.setTextColor(0, 0, 0);
    doc.text("SD NEGERI PENGKOL", 105, 28, {align: 'center'});
    
    doc.setDrawColor(200, 200, 200);
    doc.line(14, 32, 196, 32);
    
    doc.setFontSize(10);
    doc.text(`Nama Lengkap : ${curUser}`, 14, 42);
    doc.text(`Mata Pelajaran: ${t.judul}`, 14, 48);
    doc.text(`Nilai (PG)    : ${skor}`, 14, 54);
    doc.text(`Waktu Selesai : ${new Date().toLocaleString('id-ID')}`, 14, 60);

    const rows = [];
    t.soal.forEach((s, i) => {
        const tanyaBersih = s.tanya.replace(/<[^>]*>?/gm, '');
        let statusJawab = curAns[i] || "-";
        
        if(s.jenis === 'PG' && curAns[i]) {
            const isBenar = curAns[i] === s.kunci;
            statusJawab += isBenar ? " (Benar)" : ` (Salah, Kunci: ${s.kunci})`;
        }
        rows.push([i + 1, tanyaBersih, statusJawab]);
    });

    doc.autoTable({
        startY: 68,
        head: [['No', 'Pertanyaan', 'Jawaban Siswa']],
        body: rows,
        theme: 'grid',
        headStyles: { fillColor: [5, 150, 105] }, 
        columnStyles: { 0: { cellWidth: 10 }, 1: { cellWidth: 110 } }
    });

    const pdfB64 = doc.output('datauristring').split(',')[1];
    db.ref('rekap_v2').push({ nama: curUser, materi: t.judul, nilai: skor, file: pdfB64 }).then(() => {
        hideLoader(); 
        alert("Berhasil Terkirim!");
        closeView('panelSiswa');
        masukHalamanPilihTugas(curUser);
    });
}

function viewPDF(b64) {
    const blob = base64ToBlob(b64, 'application/pdf');
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
}

function base64ToBlob(base64, type) {
    const bin = atob(base64);
    const len = bin.length;
    const arr = new Uint8Array(len);
    for (let i = 0; i < len; i++) arr[i] = bin.charCodeAt(i);
    return new Blob([arr], { type: type });
}

function hapusTugasAktif(slot) { if(confirm("Akhiri tugas?")) db.ref('tugas_multi/' + slot).remove(); }
function showLoader(t) { document.getElementById('loaderText').innerText = t; document.getElementById('loader').style.display = 'flex'; }
function hideLoader() { document.getElementById('loader').style.display = 'none'; }
function openView(id) { document.getElementById(id).style.display = id.includes('modal') ? 'flex' : 'block'; }
function closeView(id) { document.getElementById(id).style.display = 'none'; }
function pindahSoal(n) { const max = dataTugas[curSlot].soal.length; if(curIdx+n >= 0 && curIdx+n < max) { curIdx += n; renderSoal(); } }
function startTimer() { timerInterval = setInterval(() => { sisaWaktu--; let m = Math.floor(sisaWaktu/60), s = sisaWaktu%60; document.getElementById('displayTimer').innerText = `${m}:${s < 10 ? '0'+s : s}`; if(sisaWaktu <= 0) submitJawaban(); }, 1000); }
function kembaliKeDaftarTugas() { if(confirm("Kembali ke daftar?")) { clearInterval(timerInterval); closeView('panelSiswa'); openView('panelPilihTugas'); } }
</script>
</body>
</html>
