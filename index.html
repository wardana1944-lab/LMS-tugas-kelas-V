<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruang Belajar - SD NEGERI PENGKOL</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      --primary: #2563eb; 
      --bg: #ffffff; 
      --surface: #f8fafc; 
      --text-main: #0f172a; 
      --text-sub: #64748b;
      --border: #e2e8f0;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
    body { background: var(--bg); color: var(--text-main); min-height: 100vh; padding: 20px 15px; }
    .container { max-width: 800px; margin: 0 auto; }

    /* MODERN HEADER */
    .brand-header { text-align: center; margin-bottom: 35px; padding-top: 10px; }
    .brand-header h1 { font-size: 2rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
    .brand-header p { font-size: 0.85rem; letter-spacing: 2px; color: var(--primary); font-weight: 700; text-transform: uppercase; margin-top: 5px; }

    /* INFO BAR CLEAN */
    .info-bar { background: var(--surface); border: 1px solid var(--border); padding: 12px 24px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .guru-profile { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 4px 8px; border-radius: 12px; transition: 0.2s; }
    .guru-profile:hover { background: #f1f5f9; }
    .guru-profile img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .guru-info { text-align: right; }
    .guru-info .nama { font-size: 0.75rem; font-weight: 700; color: var(--text-main); }
    .guru-info .nip { font-size: 0.6rem; color: var(--text-sub); font-family: monospace; }

    .banner { text-align:center; padding:14px; border-radius:14px; margin-bottom:25px; border: 1px solid #dbeafe; background: #eff6ff; color: var(--primary); font-weight: 700; font-size: 0.85rem; }

    /* GRID SISWA CLEAN */
    .grid-siswa { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .card-siswa { 
      background: #fff; border: 1px solid var(--border); padding: 20px 10px; border-radius: 20px; 
      text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      min-height: 150px; display: flex; flex-direction: column; justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.02);
    }
    .card-siswa:hover { border-color: var(--primary); transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); background: #f0f7ff; }
    .card-siswa span { font-size: 2.2rem; display: block; margin-bottom: 12px; filter: grayscale(0.2); }
    .card-siswa p { font-size: 0.7rem; font-weight: 700; color: var(--text-main); line-height: 1.3; }

    /* OVERLAY & PANEL */
    .panel-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; overflow-y: auto; padding: 30px 15px; }
    .rekap-box { background: #fff; border: 1px solid var(--border); border-radius: 20px; color: var(--text-main); overflow: hidden; margin-top: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    th { background: #f8fafc; padding: 16px; text-align: left; color: var(--text-sub); font-weight: 600; border-bottom: 1px solid var(--border); }
    td { padding: 16px; border-bottom: 1px solid #f1f5f9; }

    .btn-action { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
    .btn-action:active { transform: scale(0.98); }
    
    .soal-box { background: #f8fafc; border: 1px solid var(--border); padding: 24px; border-radius: 24px; margin-bottom: 20px; }
    input, textarea, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); margin: 10px 0; background: #fff; font-size: 0.9rem; outline: none; }
    input:focus { border-color: var(--primary); }
  </style>
</head>
<body>

<div class="container">
  <div class="brand-header">
    <h1>RUANG BELAJAR</h1>
    <p>SD NEGERI PENGKOL</p>
  </div>

  <div class="info-bar">
    <div style="font-size: 0.7rem; color: var(--text-sub); font-weight: 600;">KELAS V ‚Ä¢ 2025/2026</div>
    <div class="guru-profile" onclick="openLogin()">
      <div class="guru-info">
        <p class="nama">Aditya W. W., S.Pd</p>
        <p class="nip">NIP. 19940319 202321 1 005</p>
      </div>
      <img src="https://ui-avatars.com/api/?name=Aditya+WW&background=2563eb&color=fff">
    </div>
  </div>

  <div id="statusTugas" class="banner">Sinkronisasi data...</div>
  <div class="grid-siswa" id="gridSiswa"></div>
</div>

<div id="panelKerja" class="panel-overlay">
  <div class="container" style="max-width:600px;">
    <h4 id="namaSiswaHi" style="margin-bottom:20px; color:var(--text-sub); text-align:center;"></h4>
    <div class="soal-box">
        <p id="isiSoalTeks" style="font-weight:700; font-size:1.1rem; margin-bottom:20px; line-height:1.5;"></p>
        <textarea id="jawabanSiswa" rows="5" placeholder="Ketik jawabanmu di sini..."></textarea>
    </div>
    <button class="btn-action" style="background:var(--primary); color:white; margin-bottom:10px;" onclick="simpanDanLanjut()">SOAL BERIKUTNYA</button>
    <button id="btnSelesai" class="btn-action" style="background:#059669; color:white; display:none;" onclick="kirimTugas()">KIRIM JAWABAN</button>
    <button class="btn-action" style="background:none; color:#ef4444;" onclick="closeAllPanels()">BATALKAN</button>
  </div>
</div>

<div id="panelRekap" class="panel-overlay" style="background: #fdfdfd;">
  <div class="container">
    <h2 style="text-align:center; margin-bottom:20px;">üìä Rekap Nilai Siswa</h2>
    <div class="rekap-box">
      <table>
        <thead><tr><th>No</th><th>Nama</th><th>Status</th><th>Bukti</th></tr></thead>
        <tbody id="isiRekapTabel"></tbody>
      </table>
    </div>
    <button class="btn-action" style="background:var(--text-main); color:white; margin-top:20px;" onclick="closeView('panelRekap')">KEMBALI</button>
  </div>
</div>

<div id="panelGuru" class="panel-overlay">
  <div class="container" style="max-width: 400px; text-align:center;">
    <h2 style="margin-bottom: 30px; letter-spacing:-1px;">Menu Administrasi</h2>
    <button class="btn-action" style="background:#f1f5f9; color:var(--text-main); margin-bottom:12px;" onclick="openView('panelBuat')">üìù Buat Tugas Baru</button>
    <button class="btn-action" style="background:#f1f5f9; color:var(--text-main); margin-bottom:12px;" onclick="openView('panelRekap')">üìä Lihat Rekap Nilai</button>
    <button class="btn-action" style="background:#fee2e2; color:#ef4444; margin-bottom:12px;" onclick="resetTugas()">üóëÔ∏è Hapus Tugas Aktif</button>
    <hr style="margin:20px 0; border:none; border-top:1px solid #e2e8f0;">
    <button class="btn-action" style="background:none; color:var(--text-sub);" onclick="location.reload()">Keluar Aplikasi</button>
  </div>
</div>

<div id="panelBuat" class="panel-overlay">
  <div class="container" style="max-width: 500px;">
    <h3 style="margin-bottom:20px;">üìù Buat Materi Tugas</h3>
    <input type="text" id="judulMateri" placeholder="Contoh: Latihan Soal IPA Sifat Cahaya">
    <div id="wadahSoal"></div>
    <button class="btn-action" style="background:#f1f5f9; color:var(--primary); margin-top:10px;" onclick="tambahSoalItem()">+ Tambah Soal</button>
    <button class="btn-action" style="background:var(--primary); color:white; margin-top:20px;" onclick="terbitkanTugas()">TERBITKAN TUGAS</button>
    <button class="btn-action" style="background:none; color:#ef4444;" onclick="closeView('panelBuat')">BATAL</button>
  </div>
</div>

<div id="modalLogin" class="panel-overlay" style="background: rgba(255,255,255,0.98); display:none; align-items:center; justify-content:center;">
  <div style="width:100%; max-width:320px; text-align:center;">
    <div style="margin-bottom:20px; font-size:3rem;">üîê</div>
    <h4 style="margin-bottom:10px;">Akses Guru</h4>
    <p style="color:var(--text-sub); font-size:0.8rem; margin-bottom:20px;">Masukkan PIN untuk masuk ke menu kontrol</p>
    <input type="password" id="pinInput" placeholder="PIN" style="text-align:center; font-size:1.5rem; letter-spacing:8px; border-radius:16px;">
    <button class="btn-action" style="background:var(--text-main); color:white; margin-top:10px;" onclick="cekLogin()">MASUK</button>
    <button style="margin-top:20px; background:none; border:none; color:var(--text-sub); cursor:pointer;" onclick="closeAllPanels()">Batal</button>
  </div>
</div>

<canvas id="canvasHasil" style="display:none;"></canvas>

<script>
// SEMUA LOGIKA FUNGSI TETAP SAMA SEPERTI VERSI SEBELUMNYA
const API = "https://script.google.com/macros/s/AKfycbzKSeF0P2w2x1sszm09pLl1lEzApYHH9xbG1UISa5SoiDWfrle5L4iF7jbh8LtdqgyHvA/exec";
const SISWA = [{n:"Alvaro Adnan Aji Pambudi",i:"üë¶"},{n:"Anantha Yudha Diztira",i:"üë¶"},{n:"Arifah Yhuan Nur Azizah",i:"üëß"},{n:"Aurelia Gieni Lindria Putri",i:"üëß"},{n:"Dhafitha Nizza Nur Azizah",i:"üëß"},{n:"Dhian Rahmawati",i:"üëß"},{n:"Dimas Rasyid Faristia",i:"üë¶"},{n:"Erfin Denu Setiawan",i:"üë¶"},{n:"Marsya Anindya Kiera",i:"üëß"},{n:"Mikayla Ayuningtyas",i:"üëß"},{n:"Muhammad Ozil Ramadhan",i:"üë¶"},{n:"Rhevan Nabil Yudanta",i:"üë¶"},{n:"Ridho Wicaksono",i:"üë¶"},{n:"Rizky Syam Dani",i:"üë¶"},{n:"Tanca Al Verosa",i:"üë¶"}];

let dataWeb = null, userSkrg = "", idxSoal = 0, jwbSiswa = [];

window.onload = async () => {
  const grid = document.getElementById('gridSiswa');
  SISWA.forEach(s => { 
    grid.innerHTML += `<div class="card-siswa" onclick="mulaiTugas('${s.n}')"><span>${s.i}</span><p>${s.n}</p></div>`; 
  });
  loadData();
};

async function loadData() {
  try {
    const res = await fetch(API + "?action=getAllData");
    dataWeb = await res.json();
    document.getElementById('statusTugas').innerText = (dataWeb.tugas.judul === "TIDAK ADA TUGAS") ? "BELUM ADA TUGAS" : "TUGAS: " + dataWeb.tugas.judul;
  } catch(e) { document.getElementById('statusTugas').innerText = "Koneksi Bermasalah"; }
}

function mulaiTugas(nama) {
  if(!dataWeb || dataWeb.tugas.judul === "TIDAK ADA TUGAS") return alert("Belum ada tugas.");
  userSkrg = nama; idxSoal = 0; jwbSiswa = [];
  document.getElementById('namaSiswaHi').innerText = "Lembar Kerja: " + nama;
  openView('panelKerja');
  tampilkanSoal();
}

function tampilkanSoal() {
  const s = dataWeb.tugas.soal[idxSoal];
  document.getElementById('isiSoalTeks').innerText = (idxSoal + 1) + ". " + s.tanya;
  document.getElementById('jawabanSiswa').value = jwbSiswa[idxSoal] || "";
  document.getElementById('btnSelesai').style.display = (idxSoal === dataWeb.tugas.soal.length - 1) ? 'block' : 'none';
}

function simpanDanLanjut() {
  jwbSiswa[idxSoal] = document.getElementById('jawabanSiswa').value;
  if(idxSoal < dataWeb.tugas.soal.length - 1) { idxSoal++; tampilkanSoal(); }
  else { alert("Klik 'Kirim Jawaban' di bawah."); }
}

async function kirimTugas() {
  jwbSiswa[idxSoal] = document.getElementById('jawabanSiswa').value;
  const btn = document.getElementById('btnSelesai'); btn.innerText = "Mengirim..."; btn.disabled = true;
  const cvs = document.getElementById('canvasHasil'); const ctx = cvs.getContext('2d');
  cvs.width = 400; cvs.height = 600; ctx.fillStyle="white"; ctx.fillRect(0,0,400,600);
  ctx.fillStyle="black"; ctx.font="bold 16px Arial"; ctx.fillText("HASIL TUGAS: " + dataWeb.tugas.judul, 20, 40);
  ctx.font="14px Arial"; ctx.fillText("Nama: " + userSkrg, 20, 70);
  jwbSiswa.forEach((j, i) => { ctx.fillText((i+1) + ". " + j, 20, 110 + (i*30)); });
  const img = cvs.toDataURL("image/jpeg", 0.5).split(',')[1];
  await fetch(API, { method: "POST", body: JSON.stringify({ action:"upload", nama:userSkrg, materi:dataWeb.tugas.judul, nilai:"Selesai", file:img, filename:userSkrg+".jpg" })});
  alert("Berhasil Terkirim!"); location.reload();
}

function renderRekap() {
  const tb = document.getElementById('isiRekapTabel'); tb.innerHTML = "";
  SISWA.forEach((s, idx) => {
    const r = dataWeb.rekap.find(item => item.nama === s.n && item.materi === dataWeb.tugas.judul);
    tb.innerHTML += `<tr>
      <td>${idx+1}</td>
      <td><b>${s.n}</b></td>
      <td><span style="color:${r?'#059669':'#94a3b8'}">${r ? '‚óè Selesai' : '‚óã Belum'}</span></td>
      <td>${r ? `<a href="https://drive.google.com/uc?id=${r.link}" target="_blank" style="color:var(--primary); font-weight:700; text-decoration:none;">Buka</a>` : '-'}</td>
    </tr>`;
  });
}

function openView(id) { document.getElementById(id).style.display = 'block'; if(id === 'panelRekap') renderRekap(); }
function closeView(id) { document.getElementById(id).style.display = 'none'; }
function closeAllPanels() { document.querySelectorAll('.panel-overlay').forEach(p => p.style.display = 'none'); }
function openLogin() { document.getElementById('modalLogin').style.display = 'flex'; }
function cekLogin() { if(document.getElementById('pinInput').value === "1234") { closeAllPanels(); openView('panelGuru'); } else alert("PIN SALAH!"); }

function tambahSoalItem() {
  const html = `<div style="background:#f8fafc; padding:15px; border-radius:16px; margin-bottom:12px; border:1px solid #e2e8f0;"><b>Soal:</b><textarea class="q-tanya" rows="2"></textarea></div>`;
  document.getElementById('wadahSoal').insertAdjacentHTML('beforeend', html);
}
function resetFormSoal() { document.getElementById('wadahSoal').innerHTML = ""; tambahSoalItem(); }

async function terbitkanTugas() {
  const p = { action: "setTugas", judul: document.getElementById('judulMateri').value, jenis: "uraian", soal: [] };
  document.querySelectorAll('#wadahSoal > div').forEach(el => { p.soal.push({ tanya: el.querySelector('.q-tanya').value }); });
  await fetch(API, { method: "POST", body: JSON.stringify(p) });
  alert("Materi Terbit!"); location.reload();
}

async function resetTugas() { if(confirm("Hapus materi saat ini?")) { await fetch(API, { method: "POST", body: JSON.stringify({ action: "setTugas", judul: "TIDAK ADA TUGAS", jenis: "uraian", soal: [] }) }); location.reload(); } }
</script>
</body>
</html>
