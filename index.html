<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LMS KELAS 5 - Manajemen Tugas</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* CSS UNTUK TAMPILAN */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
    .container { max-width: 1100px; margin: 0 auto; }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; color: white; }
    .header h1 { font-size: 1.8rem; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
    .student-card { background: white; border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .student-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .avatar { width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold; font-size: 1.2rem; }
    
    /* MODAL & TOMBOL */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; position: relative; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .active { display: flex; }
    
    .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5a6fd6; }
    .btn-view { background: #10b981; color: white; padding: 6px 12px; font-size: 0.75rem; border-radius: 5px; text-decoration: none; display: inline-block; transition: 0.2s; }
    .btn-view:hover { background: #059669; transform: scale(1.05); }
    .btn-guru { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; width: auto; padding: 8px 20px; }
    .btn-guru:hover { background: white; color: #764ba2; }
    
    /* TABEL REKAP GURU */
    .summary-container { background: white; border-radius: 20px; padding: 30px; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #eee; text-align: left; font-size: 0.9rem; }
    td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.85rem; }
    .status-ok { background: #d1fae5; color: #059669; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
    .status-no { background: #fef3c7; color: #d97706; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
  </style>
</head>
<body>

<div class="container" id="mainApp">
  <div class="header">
    <h1 id="pageTitle">LMS Kelas 5</h1>
    <button class="btn btn-guru" id="btnNav" onclick="toggleGuru()">Masuk Guru</button>
  </div>

  <div id="studentView">
    <div class="cards-grid" id="cardsGrid"></div>
  </div>

  <div id="guruView" class="summary-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h2 style="color: #4b5563;">Rekapitulasi Tugas Siswa</h2>
          <p style="font-size: 0.8rem; color: #6b7280;">Daftar tugas yang telah dikirimkan ke Google Drive</p>
        </div>
        <button class="btn btn-primary" style="width: auto;" onclick="muatRekap()">Perbarui Data</button>
    </div>
    <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
                <th>No</th>
                <th>Nama Siswa</th>
                <th>Status</th>
                <th>File Terakhir</th>
                <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="rekapTable"></tbody>
        </table>
    </div>
  </div>
</div>

<div class="modal-overlay" id="uploadModal">
  <div class="modal">
    <h3 id="modalName">Nama Siswa</h3>
    <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">Silakan pilih file tugas Anda</p>
    <input type="file" id="fileInput" style="margin: 20px 0; width: 100%;">
    <button class="btn btn-primary" onclick="uploadKeDrive()" id="uploadBtn">Kirim Tugas</button>
    <button class="btn" onclick="tutupModal()">Batal</button>
  </div>
</div>

<script>
  // URL SCRIPT ANDA
  const scriptURL = "https://script.google.com/macros/s/AKfycbw1AzuruSrFen96aaYug0k3s_CdG3KP6_MJjMjKWLyom0uzOgGA_YXzYjxS5NKC_xw/exec";

  const SISWA = [
    "Alvaro Adnan Aji Pambudi", "Anantha Yudha Diztira", "Arifah Yhuan Nur Azizah", 
    "Aurelia Gieni Lindria Putri", "Dhafitha Nizza Nur Azizah", "Dhian Rahmawati", 
    "Dimas Rasyid Faristia", "Erfin Denu Setiawan", "Marsya Anindya Kiera", 
    "Mikayla Ayuningtyas", "Muhammad Ozil Ramadhan", "Rhevan Nabil Yudanta", 
    "Ridho Wicaksono", "Rizky Syam Dani", "Tanca Al Verosa"
  ];
  
  let siswaTerpilih = "";
  let modeGuru = false;

  const grid = document.getElementById('cardsGrid');
  SISWA.forEach(s => {
    grid.innerHTML += `
      <div class="student-card" onclick="bukaUpload('${s}')">
        <div class="avatar">${s.charAt(0)}</div>
        <div style="font-weight: 600; font-size: 0.9rem;">${s}</div>
      </div>`;
  });

  function bukaUpload(nama) {
    siswaTerpilih = nama;
    document.getElementById('modalName').innerText = nama;
    document.getElementById('uploadModal').classList.add('active');
  }

  function tutupModal() {
    document.getElementById('uploadModal').classList.remove('active');
    document.getElementById('fileInput').value = "";
  }

  function uploadKeDrive() {
    const fileInput = document.getElementById('fileInput');
    if (fileInput.files.length === 0) return alert("Pilih file terlebih dahulu!");
    
    const btn = document.getElementById('uploadBtn');
    const originalText = btn.innerText;
    btn.innerText = "Mengirim... Mohon Tunggu";
    btn.disabled = true;

    const file = fileInput.files[0];
    const fr = new FileReader();
    fr.readAsDataURL(file);
    fr.onload = function(e) {
      const payload = {
        base64: e.target.result.split(",")[1],
        type: file.type,
        name: siswaTerpilih + " - " + file.name,
        siswa: siswaTerpilih
      };

      fetch(scriptURL, { method: "POST", body: JSON.stringify(payload) })
      .then(r => r.json())
      .then(res => {
        if(res.status === 'success') {
            alert("Berhasil! Tugas " + siswaTerpilih + " telah terkirim.");
            tutupModal();
        } else {
            alert("Terjadi kesalahan: " + res.message);
        }
      })
      .catch(err => alert("Gagal terhubung ke server. Periksa koneksi atau izin skrip."))
      .finally(() => {
        btn.innerText = originalText;
        btn.disabled = false;
      });
    };
  }

  function toggleGuru() {
    if (!modeGuru) {
      const pass = prompt("Masukkan Kata Sandi Guru:");
      if (pass !== "guru123") return alert("Kata Sandi Salah!");
      document.getElementById('studentView').style.display = "none";
      document.getElementById('guruView').style.display = "block";
      document.getElementById('btnNav').innerText = "Kembali ke Beranda";
      document.getElementById('pageTitle').innerText = "Dashboard Guru";
      modeGuru = true;
      muatRekap();
    } else {
      location.reload();
    }
  }

  function muatRekap() {
    const tbody = document.getElementById('rekapTable');
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Memuat data rekapitulasi...</td></tr>";

    fetch(scriptURL)
    .then(r => r.json())
    .then(data => {
      tbody.innerHTML = "";
      SISWA.forEach((s, i) => {
        const historySiswa = data.filter(row => row[1] === s);
        const sudahUpload = historySiswa.length > 0;
        const status = sudahUpload ? `<span class="status-ok">Sudah Kirim</span>` : `<span class="status-no">Belum Kirim</span>`;
        const fileName = sudahUpload ? historySiswa[historySiswa.length - 1][2] : "-";
        
        // Link preview mengambil ID File dari kolom ke-4 di Excel
        const fileId = sudahUpload ? historySiswa[historySiswa.length - 1][3] : null;
        const previewBtn = fileId ? `<a href="https://drive.google.com/open?id=${fileId}" target="_blank" class="btn-view">Lihat File</a>` : "-";
        
        tbody.innerHTML += `<tr>
          <td>${i+1}</td>
          <td>${s}</td>
          <td>${status}</td>
          <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fileName}</td>
          <td>${previewBtn}</td>
        </tr>`;
      });
    })
    .catch(err => {
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color:red;'>Gagal memuat rekap. Pastikan izin skrip sudah 'Anyone'.</td></tr>";
    });
  }
</script>
</body>
</html>

